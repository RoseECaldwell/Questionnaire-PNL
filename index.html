<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test des métaprogrammes, découvrez votre profil amoureux et ses compatibilités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Poppins:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0d1f1f;
      --card-dark: #162828;
      --button-dark: #222;
      --button-gradient: linear-gradient(90deg,#ff70a6,#36e3e4 60%,#7cf47c 100%);
      --glow: 0 0 6px 2px #36e3e480, 0 0 18px 4px #ff70a680;
      --progress-gradient: linear-gradient(90deg, #ff70a6, #ffe17b 50%, #7cf47c 100%);
      --heart-gradient: linear-gradient(135deg, #1d2c7a 0%, #36e3e4 55%, #ff70a6 100%);
    }
    html, body {
      min-height: 100%;
      background: var(--bg-dark);
      color: #fff;
      font-family: 'Montserrat', 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      justify-content: flex-start;
      align-items: center;
      background: var(--bg-dark);
    }
    .container {
      width: 100%;
      max-width: 480px;
      margin: 32px auto 0 auto;
      padding: 0 14px 80px 14px;
      position: relative;
    }
    .header-flex {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 0.7em;
    }
    h1 {
      font-size: 1.45rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.1em;
      margin-top: 0.4em;
      letter-spacing: -0.01em;
      line-height: 1.3;
      flex: 1 1 auto;
    }
    .heart {
      width: 70px;
      height: 66px;
      margin: 0;
      display: block;
      position: relative;
      z-index: 1;
      flex: 0 0 auto;
    }
    .heart svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .inspiration {
      font-size: 1.07rem;
      line-height: 1.5;
      text-align: center;
      color: #ffe17bcc;
      margin-bottom: 1.7em;
      font-style: italic;
    }
    .question-card {
      background: var(--card-dark);
      border-radius: 18px;
      box-shadow: 0 4px 24px #000c  ;
      padding: 34px 22px 28px 22px;
      margin-bottom: 2em;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 1;
      transition: opacity 0.3s;
    }
    .question-fade {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .question-number {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ffe17b;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }
    .question-text {
      font-size: 1.12rem;
      font-weight: 500;
      text-align: center;
      color: #fff;
      margin-bottom: 30px;
      margin-top: 0;
    }
    .answers {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      margin-bottom: 0.5em;
      align-items: center;
    }
    .answer-btn {
      width: 95%;
      max-width: 340px;
      padding: 14px 0;
      background: #191f2a;
      border: 2px solid #2b3b3d;
      color: #fff;
      border-radius: 100px;
      font-size: 1.07rem;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      margin: 0 auto;
      outline: none;
      transition: background 0.23s, box-shadow 0.23s, border-color 0.18s, color 0.18s;
      box-shadow: 0 2px 10px #1116;
      position: relative;
      letter-spacing: 0.03em;
    }
    .answer-btn.selected, .answer-btn:active {
      background: var(--button-gradient);
      color: #0d1f1f;
      border: 2px solid #ffe17b;
      box-shadow: 0 0 0 2px #fff3, 0 0 10px 4px #ffe17b33;
    }
    .answer-btn:hover:not(.selected) {
      background: #2d3c43;
      color: #ffe17b;
      border-color: #36e3e4;
      box-shadow: var(--glow);
    }
    .alert {
      display: none;
      color: #ff70a6;
      background: #fff1;
      border-radius: 8px;
      font-size: 1.06rem;
      margin: 12px 0 0 0;
      padding: 8px 12px;
      text-align: center;
    }
    .show-alert {
      display: block;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .next-btn {
      display: block;
      margin: 28px auto 0 auto;
      padding: 12px 40px;
      background: var(--button-dark);
      border: none;
      border-radius: 100px;
      color: #fff;
      font-size: 1.13rem;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 18px 0 #36e3e4a0, 0 0 18px 2px #ff70a6a0;
      letter-spacing: 0.05em;
      text-shadow: 0 0 8px #ff70a6, 0 0 10px #36e3e4;
      background-image: var(--button-gradient);
      background-size: 220% 100%;
      background-position: left center;
      transition: background-position 0.3s, box-shadow 0.23s;
    }
    .next-btn:hover, .next-btn:focus {
      background-position: right center;
      box-shadow: 0 0 24px 2px #7cf47c99, 0 0 24px 6px #ffe17b66;
      outline: none;
    }
    .progress-bar-bg {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      height: 7px;
      background: #1a3434;
      z-index: 10;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: var(--progress-gradient);
      border-radius: 0 12px 12px 0;
      transition: width 0.4s cubic-bezier(.8,.1,.2,1);
    }
    /* Email block */
    .result-block {
      background: var(--card-dark);
      border-radius: 16px;
      box-shadow: 0 4px 24px #000c;
      padding: 30px 20px 24px 20px;
      margin: 36px 0 28px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.7s;
    }
    .email-label {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #ffe17b;
      font-weight: 600;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .email-input, .consent-checkbox {
      margin: 10px 0 18px 0;
      width: 96%;
      max-width: 340px;
      padding: 12px;
      border-radius: 6px;
      border: 1.5px solid #36e3e4;
      font-size: 1.07rem;
      font-family: inherit;
      background: #181f20;
      color: #fff;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s;
    }
    .email-input:focus {
      border-color: #ff70a6;
    }
    .consent-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 1.01rem;
      color: #fff;
    }
    .consent-checkbox {
      width: 20px;
      height: 20px;
      margin: 0 7px 0 0;
      accent-color: #ff70a6;
      cursor: pointer;
    }
    .submit-btn {
      margin: 20px auto 0 auto;
      padding: 13px 44px;
      background: var(--button-dark);
      border: none;
      border-radius: 100px;
      color: #fff;
      font-size: 1.13rem;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--glow);
      letter-spacing: 0.05em;
      text-shadow: 0 0 8px #ff70a6, 0 0 10px #36e3e4;
      background-image: var(--button-gradient);
      background-size: 220% 100%;
      background-position: left center;
      transition: background-position 0.3s, box-shadow 0.23s;
      display: block;
    }
    .submit-btn:hover, .submit-btn:focus {
      background-position: right center;
      box-shadow: 0 0 24px 2px #7cf47c99, 0 0 24px 6px #ffe17b66;
      outline: none;
    }
    .email-duplicate-msg {
      color: #ffe17b;
      background: #ff70a61c;
      border-radius: 7px;
      font-size: 1.06rem;
      margin: 14px 0 0 0;
      padding: 7px 10px;
      text-align: center;
      display: none;
      animation: fadeIn 0.5s;
    }
    .success-msg {
      color: #7cf47c;
      background: #36e3e41a;
      border-radius: 7px;
      font-size: 1.15rem;
      margin: 28px 0 0 0;
      padding: 14px 16px;
      text-align: center;
      display: none;
      animation: fadeIn 0.7s;
    }
    .g-recaptcha {
      margin: 18px auto 14px auto;
      display: flex;
      justify-content: center;
    }
    @media (max-width: 600px) {
      .container { max-width: 100vw; padding: 0 2vw 80px 2vw;}
      .question-card, .result-block { padding: 18px 5vw 18px 5vw;}
      .header-flex { gap: 10px;}
      .heart { width: 46px; height: 44px;}
      h1 { font-size: 1.03rem; }
    }
  </style>
  <!-- Google reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <div class="container">

    <!-- Header flex: Heart + Title -->
    <div class="header-flex">
      <div class="heart">
        <svg viewBox="0 0 60 54" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#1d2c7a"/>
              <stop offset="55%" stop-color="#36e3e4"/>
              <stop offset="100%" stop-color="#ff70a6"/>
            </linearGradient>
          </defs>
          <path fill="url(#heartGradient)" d="M30 50.8l-2.9-2.6C12 35 2 26.6 2 16.5 2 8.5 8.47 2 16.5 2 21.2 2 25.7 4.7 28 8.7 30.3 4.7 34.8 2 39.5 2 47.5 2 54 8.5 54 16.5c0 10.1-10 18.5-25.1 31.7L30 50.8z"/>
        </svg>
      </div>
      <h1>Test des métaprogrammes, découvrez votre profil amoureux et ses compatibilités</h1>
    </div>

    <div class="inspiration">Répondez spontanément, il n’y a pas de bonne ou mauvaise réponse.</div>

    <!-- Question Card -->
    <div id="question-card" class="question-card">
      <div class="question-number" id="question-number">1.</div>
      <div class="question-text" id="question-text">
        <!-- Question text here -->
      </div>
      <div class="answers">
        <button class="answer-btn" data-value="0" id="answer-jamais">Jamais</button>
        <button class="answer-btn" data-value="25" id="answer-rarement">Rarement</button>
        <button class="answer-btn" data-value="75" id="answer-souvent">Souvent</button>
        <button class="answer-btn" data-value="100" id="answer-toujours">Toujours</button>
      </div>
      <div class="alert" id="alert">💡 Merci de répondre à la question pour continuer, cela rendra votre profil plus précis ❤️</div>
      <button class="next-btn" id="next-btn">Suivant</button>
    </div>

    <!-- Email & Result Block -->
    <form id="result-block" class="result-block" style="display:none;" autocomplete="off">
      <label for="email" class="email-label">Recevez votre analyse personnalisée par e-mail :</label>
      <input id="email" type="email" class="email-input" name="email" placeholder="Votre adresse e-mail" required autocomplete="email" />
      <div id="email-duplicate-msg" class="email-duplicate-msg"></div>
      <div class="consent-row">
        <input type="checkbox" id="consent" name="consent" class="consent-checkbox" required />
        <label for="consent" style="margin:0;line-height:1.2;">
          Oui, je souhaite recevoir mon analyse par e-mail et rester informé(e) des nouveautés MetaLove, y compris des bonus exclusifs et des prochains livres à paraître.
        </label>
      </div>
      <div class="g-recaptcha" data-sitekey="6Lflyc4rAAAAAMOncHSIV9Y4IW3SF6m-QLZMMxAh" data-callback="onSubmit"></div>
      <button type="submit" class="submit-btn">Envoyer</button>
      <div id="success-msg" class="success-msg"></div>
    </form>
  </div>

  <div class="progress-bar-bg"><div id="progress-bar" class="progress-bar"></div></div>

  <script>
    // --- DATASETS ---
    // Questions: [pan, questionText]
    const questionsRaw = [
      // VAKOG
      ["Visuel","Vous souvenez-vous plus facilement des visages que des noms ?"],
      ["Visuel","Aimez-vous organiser votre espace de travail de façon esthétique et harmonieuse ?"],
      ["Visuel","Choisissez-vous vos vêtements principalement en fonction de leur apparence visuelle ?"],
      ["Visuel","Lorsqu'on vous explique quelque chose, préférez-vous voir un schéma ou un dessin à la place ?"],
      ["Visuel","Avez-vous tendance à visualiser mentalement vos projets ou vos idées ?"],
      ["Auditif","Lorsque vous entendez une voix familière, la reconnaissez-vous rapidement, même sans voir la personne ?"],
      ["Auditif","Entendez-vous une voix intérieure qui accompagne votre lecture, comme si vous vous racontiez l’histoire à vous-même ?"],
      ["Auditif","Lorsqu’on vous donne des consignes, les retenir à l’oral vous est-il facile ?"],
      ["Auditif","Le bruit de fond vous gêne-t-il facilement pour vous concentrer ?"],
      ["Auditif","Avez-vous besoin de verbaliser vos idées à haute voix pour les clarifier ?"],
      ["Kinesthésique","Êtes-vous particulièrement sensible à la texture des vêtements que vous portez ?"],
      ["Kinesthésique","Avez-vous du mal à rester concentré(e) sans bouger, même légèrement ?"],
      ["Kinesthésique","Apprenez-vous plus facilement en manipulant ou en expérimentant directement ?"],
      ["Kinesthésique","Avez-vous besoin de ressentir physiquement un lieu pour savoir si vous vous y sentez bien ?"],
      ["Kinesthésique","Évitez-vous certains vêtements, même beaux, s’ils sont trop serrés ou inconfortables ?"],
      // Option/Procédure
      ["Option","Aimez-vous avoir plusieurs manières possibles d’aborder une même tâche ?"],
      ["Option","Préférez-vous improviser plutôt que suivre une méthode fixe ?"],
      ["Option","Vous sentez-vous limité(e) lorsqu’on vous impose une seule façon de faire ?"],
      ["Option","Avez-vous tendance à adapter les règles plutôt qu’à les suivre strictement ?"],
      ["Option","Appréciez-vous les formations ouvertes plutôt que très structurées ?"],
      ["Procédure","Avez-vous besoin de consignes claires avant de commencer une tâche ?"],
      ["Procédure","Préférez-vous suivre une méthode pas à pas plutôt que d’improviser ?"],
      ["Procédure","Est-ce que l’absence de cadre vous déstabilise ?"],
      ["Procédure","Aimez-vous quand les choses sont bien organisées et logiques ?"],
      ["Procédure","Vous sentez-vous plus efficace avec un plan établi à l’avance ?"],
      // Proactif/Réactif
      ["Proactif","Prenez-vous souvent les devants pour résoudre un problème ?"],
      ["Proactif","Initiez-vous souvent les projets ou les discussions ?"],
      ["Proactif","Avez-vous tendance à agir plutôt qu’attendre ?"],
      ["Proactif","Êtes-vous à l’aise dans les situations qui demandent de la réactivité ?"],
      ["Proactif","Cherchez-vous rapidement des solutions quand un obstacle survient ?"],
      ["Réactif","Avez-vous besoin de prendre le temps de réfléchir avant d’agir ?"],
      ["Réactif","Préférez-vous observer avant de vous lancer dans une nouvelle activité ?"],
      ["Réactif","Avez-vous tendance à réagir plutôt qu’à initier ?"],
      ["Réactif","Est-ce que vous vous sentez plus à l’aise lorsqu’un cadre est déjà posé ?"],
      ["Réactif","L’attente d’un déclencheur extérieur vous rassure-t-elle avant de commencer ?"],
      // Motivation
      ["Pouvoir","Souhaitez-vous influencer les décisions dans un groupe ?"],
      ["Pouvoir","Vous sentez-vous motivé(e) par le fait d’être reconnu(e) comme leader ?"],
      ["Pouvoir","Avez-vous besoin d’avoir le contrôle sur ce que vous entreprenez ?"],
      ["Pouvoir","Est-ce que relever des défis vous stimule ?"],
      ["Pouvoir","Avez-vous tendance à vouloir réaliser ce qu’on vous croit incapable de faire ?"],
      ["Objectif","Vous fixez-vous des buts clairs avant d’agir ?"],
      ["Objectif","Avez-vous besoin d’un résultat concret pour vous sentir motivé(e) ?"],
      ["Objectif","Est-ce que la performance pour vous s’évalue par l’atteinte d’un résultat plutôt que par ce que vous avez appris ?"],
      ["Objectif","Planifiez-vous vos actions avec une idée précise du résultat attendu ?"],
      ["Objectif","Vous sentez-vous plus à l’aise quand vous savez exactement où vous allez ?"],
      ["Affiliation","Est-il important pour vous d’être bien intégré(e) dans un groupe ?"],
      ["Affiliation","Cherchez-vous à créer des liens avant tout dans un nouveau contexte ?"],
      ["Affiliation","Préférez-vous collaborer que réussir seul(e) ?"],
      ["Affiliation","L’ambiance dans une équipe est-elle plus importante que le salaire que vous gagnez ?"],
      ["Affiliation","Faites-vous attention à ne pas blesser les autres dans vos choix ?"],
      // Rapport au temps
      ["Passé","Vous appuyez-vous sur vos expériences pour prendre des décisions ?"],
      ["Passé","Avez-vous tendance à vous référer à ce que vous connaissez déjà ?"],
      ["Passé","Préférez-vous les traditions aux nouveautés ?"],
      ["Passé","Revenez-vous souvent sur des événements passés pour comprendre le présent ?"],
      ["Passé","Est-ce que vos souvenirs guident souvent vos choix ?"],
      ["Présent","Vous concentrez-vous davantage sur ce que vous vivez ici et maintenant ?"],
      ["Présent","Avez-vous du mal à faire des plans à long terme ?"],
      ["Présent","Est-ce que vous agissez surtout en fonction de ce qui se passe aujourd’hui ?"],
      ["Présent","Vous sentez-vous guidé(e) par vos ressentis du moment ?"],
      ["Présent","Réagissez-vous davantage à ce qui se passe tout de suite qu’à ce qui pourrait arriver ?"],
      ["Futur","Faites-vous souvent des projets à long terme ?"],
      ["Futur","Avez-vous besoin de visualiser l’avenir pour vous sentir motivé(e) ?"],
      ["Futur","Planifiez-vous beaucoup ce que vous allez faire dans les semaines à venir ?"],
      ["Futur","Pensez-vous souvent à ce que vous voulez devenir ?"],
      ["Futur","Anticipez-vous les conséquences futures de vos décisions ?"],
      // Olfactif/Gustatif
      ["Olfactif","Les odeurs influencent-elles facilement votre humeur ?"],
      ["Olfactif","Êtes-vous très sensible aux parfums ou aux odeurs fortes ?"],
      ["Olfactif","Vous rappelez-vous facilement d’une personne grâce à son odeur ?"],
      ["Olfactif","Avez-vous des odeurs préférées qui vous apaisent ou vous stimulent ?"],
      ["Olfactif","Une odeur peut-elle suffire à vous rappeler un souvenir ?"],
      ["Gustatif","Le goût influence-t-il fortement votre expérience d’un moment ?"],
      ["Gustatif","Choisissez-vous des lieux ou événements selon ce que vous allez y manger ?"],
      ["Gustatif","Vous arrive-t-il de manger juste pour le plaisir du goût, sans faim ?"],
      ["Gustatif","Un bon plat peut-il améliorer votre humeur ?"],
      ["Gustatif","Le partage de repas est-il un moment important pour vous ?"],
      // Orientation
      ["Tourné vers soi","Pensez-vous d’abord à vous avant d’aider les autres ?"],
      ["Tourné vers soi","Votre propre bien-être passe-t-il en priorité dans vos décisions ?"],
      ["Tourné vers soi","Avez-vous besoin d’être aligné(e) avec vous-même avant d’agir ?"],
      ["Tourné vers soi","Votre confort personnel est-il une condition essentielle à votre implication ?"],
      ["Tourné vers soi","Faites-vous passer vos besoins en premier dans un groupe ?"],
      ["Tourné vers les autres","Anticipez-vous souvent les besoins ou attentes des autres ?"],
      ["Tourné vers les autres","Vos choix sont-ils souvent guidés par le plaisir que cela procurera aux autres ?"],
      ["Tourné vers les autres","Préférez-vous faire plaisir quitte à vous contraindre un peu ?"],
      ["Tourné vers les autres","Vous sentez-vous responsable du bien-être des autres ?"],
      ["Tourné vers les autres","Est-il important pour vous d’être perçu(e) comme quelqu’un d’attentionné ?"],
      // Focus
      ["Global","Aimez-vous comprendre les grandes lignes avant d’entrer dans les détails ?"],
      ["Global","Préférez-vous les visions d’ensemble aux explications minutieuses ?"],
      ["Global","Avez-vous besoin de situer les choses dans un cadre général ?"],
      ["Global","Est-ce que les détails vous intéressent surtout une fois la vue d’ensemble comprise ?"],
      ["Global","Avez-vous du mal à rester concentré(e) sur des choses trop précises ?"],
      ["Détail","Aimez-vous décortiquer les choses en éléments précis ?"],
      ["Détail","Sur un mur nouvellement peint, allez-vous voir instantanément le petit détail mal fait ?"],
      ["Détail","Vous attachez-vous aux détails avant d’embrasser une vision globale ?"],
      ["Détail","Les choses inexactes ou floues vous mettent-elles mal à l’aise ?"],
      ["Détail","Vous sentez-vous rassuré(e) par des données précises ?"],
      // Énergie
      ["Introverti","Avez-vous besoin de calme pour vous ressourcer ?"],
      ["Introverti","Préférez-vous les interactions en petit comité ?"],
      ["Introverti","Le temps seul(e) est-il vital pour votre équilibre ?"],
      ["Introverti","Trouvez-vous fatigantes les réunions sociales prolongées ?"],
      ["Introverti","Vous sentez-vous plus vous-même dans l’intimité que dans un groupe ?"],
      ["Extraverti","Vous sentez-vous énergisé(e) par la présence des autres ?"],
      ["Extraverti","Avez-vous tendance à parler pour réfléchir ?"],
      ["Extraverti","Cherchez-vous la compagnie plutôt que la solitude ?"],
      ["Extraverti","Les environnements dynamiques vous stimulent-ils ?"],
      ["Extraverti","Préférez-vous partager vos pensées plutôt que les garder pour vous ?"]
    ];

    // Mapping PAN to Metaprogramme (invisible logic)
    const panToMeta = {
      "Visuel": "VAKOG", "Auditif": "VAKOG", "Kinesthésique": "VAKOG", "Olfactif": "VAKOG", "Gustatif": "VAKOG",
      "Procédure": "Procédure/Option", "Option": "Procédure/Option",
      "Proactif": "Proactif/Réactif", "Réactif": "Proactif/Réactif",
      "Passé": "Rapport au temps", "Présent": "Rapport au temps", "Futur": "Rapport au temps",
      "Pouvoir": "Motivation", "Objectif": "Motivation", "Affiliation": "Motivation",
      "Tourné vers soi": "Orientation", "Tourné vers les autres": "Orientation",
      "Introverti": "Énergie", "Extraverti": "Énergie",
      "Détail": "Focus", "Global": "Focus"
    };

    // For result placeholders (order: as in demo)
    const metaprogrammePans = {
      "Procédure/Option":["Procédure","Option"],
      "Motivation":["Pouvoir","Objectif","Affiliation"],
      "Énergie":["Introverti","Extraverti"],
      "Proactif/Réactif": ["Proactif","Réactif"],
      "Rapport au temps": ["Passé","Présent","Futur"],
      "Orientation": ["Tourné vers soi","Tourné vers les autres"],
      "VAKOG": ["Visuel","Auditif","Kinesthésique","Olfactif","Gustatif"],
      "Focus": ["Détail","Global"]
    };

    // Interpretation templates (FR, warm)
    const interpretationTemplates = {
      "Motivation": {
        "Pouvoir": "Deux Pouvoir élevés → couple explosif. Équilibre si Pouvoir avec Objectif ou Affiliation.",
        "Objectif": "Compatibilité forte avec Affiliation. Un Objectif dominant tempère un Pouvoir.",
        "Affiliation": "Idéal avec Objectif. Risque de dépendance si deux Affiliation élevés."
      },
      "Proactif_Réactif": {
        "Proactif": "Deux Proactifs → passion et vitesse, mais risque de précipitation.",
        "Réactif": "Deux Réactifs → sécurité et stabilité, mais inertie possible.",
        "Mix": "Équilibre entre action et réflexion."
      },
      "Option_Procédure": {
        "Procédure": "Deux Procédure → rigueur et organisation, mais rigidité.",
        "Option": "Deux Option → liberté et créativité, mais instabilité.",
        "Mix": "Équilibre entre structure et créativité."
      },
      "Rapport_Temps": {
        "Passé_Futur": "Passé dominant vs Futur dominant → incompréhensions (mémoire vs projection).",
        "Présent": "Deux Présents → intensité dans l’instant, mais insouciance possible.",
        "Mix": "Harmonie si un partenaire vit dans le présent et l’autre dans le futur (vision) ou passé (stabilité)."
      },
      "Énergie": {
        "Introverti": "Deux Introvertis → compréhension silencieuse et paisible.",
        "Extraverti": "Deux Extravertis → complicité énergique.",
        "Mix": "Si un 60%+ Introverti vs un 60%+ Extraverti → tensions et incompréhensions."
      }
    };

    // Example long-form interpretation (used for segmentation)
    const exampleSegments = [
      "« Votre profil amoureux révèle une énergie singulière. Si la Motivation Pouvoir domine, vous êtes attiré(e) par l’influence et l’affirmation de soi, ce qui peut séduire mais aussi générer des tensions si votre partenaire partage la même intensité. L’équilibre naît lorsque Pouvoir rencontre Objectif ou Affiliation, car l’un apporte direction et l’autre connexion. Un Objectif dominant offre clarté et progression, idéalement complété par une Affiliation chaleureuse qui renforce la complicité. »",
      "« Votre dynamique Proactif / Réactif façonne votre rythme amoureux. Deux Proactifs créent une relation passionnée et stimulante, mais peuvent parfois foncer tête baissée. Deux Réactifs privilégient la sécurité et la stabilité, au risque de manquer d’élan. La combinaison des deux offre souvent le meilleur équilibre : l’un initie, l’autre tempère. Votre couple trouve ainsi une cadence naturelle entre action et réflexion, gage de longévité et d’harmonie. »",
      "« Le duo Procédure / Option reflète votre rapport aux règles et à la créativité. Deux profils Procédure partagent une rigueur rassurante, mais peuvent s’enfermer dans la routine. Deux Option vivent l’instant, cultivant la liberté, mais risquent l’instabilité. Un couple mixte allie solidité et spontanéité, permettant d’évoluer dans un cadre souple. Si vous êtes majoritairement Option, cherchez un(e) partenaire qui saura canaliser vos élans sans brider votre inspiration. »",
      "« Enfin, votre rapport au Temps et à l’Énergie influence la compatibilité. Deux Présents vivent une intensité grisée, mais peuvent manquer de projection. Le Passé s’attache aux racines, le Futur bâtit des projets : ces visions différentes nécessitent dialogue pour s’harmoniser. Côté Énergie, deux Introvertis s’accordent dans une bulle intime, deux Extravertis partagent une complicité vive. Les écarts trop marqués (60%+ Introverti vs 60%+ Extraverti) exigent plus d’efforts de compréhension. »"
    ];

    // --- STATE ---
    let currentQ = 0;
    let answers = []; // {pan, value}
    let selected = null;

    // --- Shuffle questions on session start ---
    function shuffleArray(arr) {
      // Fisher-Yates shuffle
      let a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    // Use local variable so the order is fixed for one session/visit
    const questions = shuffleArray(questionsRaw);

    // --- DOM ELEMENTS ---
    const qCard = document.getElementById('question-card');
    const qNumber = document.getElementById('question-number');
    const qText = document.getElementById('question-text');
    const answerBtns = Array.from(document.getElementsByClassName('answer-btn'));
    const nextBtn = document.getElementById('next-btn');
    const alertBox = document.getElementById('alert');
    const progressBar = document.getElementById('progress-bar');

    // Result block
    const resultBlock = document.getElementById('result-block');
    const emailInput = document.getElementById('email');
    const consentBox = document.getElementById('consent');
    const emailDupMsg = document.getElementById('email-duplicate-msg');
    const successMsg = document.getElementById('success-msg');

    // --- LOGIC ---

    function showQuestion(idx) {
      // Fade out
      qCard.classList.add('question-fade');
      setTimeout(()=>{
        // Set question
        qNumber.textContent = (idx+1) + ".";
        qText.textContent = questions[idx][1];
        answerBtns.forEach(btn => btn.classList.remove('selected'));
        selected = null;
        alertBox.classList.remove('show-alert');
        // Fade in
        qCard.classList.remove('question-fade');
        // Progress bar
        progressBar.style.width = ((idx/105)*100).toFixed(2) + "%";
      }, 210);
    }

    answerBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        answerBtns.forEach(b=>b.classList.remove('selected'));
        this.classList.add('selected');
        selected = parseInt(this.dataset.value);
        alertBox.classList.remove('show-alert');
      });
    });

    nextBtn.addEventListener('click', function() {
      if(selected === null){
        alertBox.classList.add('show-alert');
        return;
      }
      // Save answer
      answers[currentQ] = { pan: questions[currentQ][0], value: selected };
      // Next
      currentQ++;
      if(currentQ < questions.length){
        showQuestion(currentQ);
      }else{
        // End: show results block
        qCard.classList.add('question-fade');
        setTimeout(()=>{
          qCard.style.display = 'none';
          resultBlock.style.display = 'flex';
          progressBar.style.width = "100%";
          window.scrollTo({top:0,behavior:'smooth'});
        },300);
      }
    });

    // --- INITIALIZE ---
    showQuestion(0);

    // --- Results & Normalization ---
    function computeResults() {
      // Compute raw totals per pan
      const panTotals = {};
      const panCounts = {};
      answers.forEach(({pan,value})=>{
        panTotals[pan] = (panTotals[pan]||0) + value;
        panCounts[pan] = (panCounts[pan]||0) + 1;
      });
      // For each metaprogramme, normalize so its pans sum = 100%
      const metaScores = {};
      Object.keys(metaprogrammePans).forEach(meta=>{
        const pans = metaprogrammePans[meta];
        let total = 0;
        let panRaw = pans.map(p=>panTotals[p]||0);
        total = panRaw.reduce((a,b)=>a+b,0);
        // Normalize
        metaScores[meta] = {};
        pans.forEach((p,i)=>{
          let norm = total>0 ? Math.round(100*panRaw[i]/total) : 0;
          metaScores[meta][p] = norm;
        });
      });
      return metaScores;
    }

    // --- Results Serialization (for webhook) ---
    function buildPayload(email, captchaToken) {
      const scores = computeResults();
      return {
        bonus_id: "tome1",
        response: captchaToken,
        email,
        // Placeholders for all metaprogrammes
        "procédure_score": scores["Procédure/Option"]["Procédure"],
        "option_score": scores["Procédure/Option"]["Option"],
        "pouvoir_score": scores["Motivation"]["Pouvoir"],
        "objectif_score": scores["Motivation"]["Objectif"],
        "affiliation_score": scores["Motivation"]["Affiliation"],
        "introverti_score": scores["Énergie"]["Introverti"],
        "extraverti_score": scores["Énergie"]["Extraverti"],
        "proactif_score": scores["Proactif/Réactif"]["Proactif"],
        "réactif_score": scores["Proactif/Réactif"]["Réactif"],
        "passé_score": scores["Rapport au temps"]["Passé"],
        "présent_score": scores["Rapport au temps"]["Présent"],
        "futur_score": scores["Rapport au temps"]["Futur"],
        "vers_soi_score": scores["Orientation"]["Tourné vers soi"],
        "vers_autres_score": scores["Orientation"]["Tourné vers les autres"],
        "visuel_score": scores["VAKOG"]["Visuel"],
        "auditif_score": scores["VAKOG"]["Auditif"],
        "kinesthésique_score": scores["VAKOG"]["Kinesthésique"],
        "olfactif_score": scores["VAKOG"]["Olfactif"],
        "gustatif_score": scores["VAKOG"]["Gustatif"],
        "détail_score": scores["Focus"]["Détail"],
        "global_score": scores["Focus"]["Global"],
        // Add interpretation segments placeholder (for email)
        "segments_part1": buildInterpretationSegments(scores,0),
        "segments_part2": buildInterpretationSegments(scores,1),
        "segments_part3": buildInterpretationSegments(scores,2),
        "segments_part4": buildInterpretationSegments(scores,3)
      };
    }

    // --- Interpretation logic (only 5 key metaprogrammes) ---
    function buildInterpretationSegments(scores, partIdx){
      // Use example segments for now, or can be customized below.
      // You can extend here by analyzing the scores to personalize the segment.
      return exampleSegments[partIdx];
    }

    // --- Form Submission & reCAPTCHA Logic ---
    let lastCaptchaToken = "";
    window.onSubmit = function(token){
      lastCaptchaToken = token;
    };

    resultBlock.addEventListener('submit', function(e){
      e.preventDefault();
      emailDupMsg.style.display = 'none';
      successMsg.style.display = 'none';

      // Validate
      const email = emailInput.value.trim();
      if(!email || !consentBox.checked){
        if(!email) emailInput.focus();
        return;
      }
      // Validate captcha
      if(!lastCaptchaToken){
        alert("Captcha invalide. Merci de réessayer.");
        return;
      }

      // Build payload
      const payload = buildPayload(email, lastCaptchaToken);

      // POST
      fetch("https://hook.eu2.make.com/nq8suncrqqr7vqvothftezfygqrufqh2",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.text())
      .then(responseText => {
        if(responseText.includes("duplicate")){
          emailDupMsg.textContent = "⚠️ Cette adresse e-mail a déjà servi pour un test 💡. Merci d’en indiquer une autre afin de recevoir une nouvelle interprétation.";
          emailDupMsg.style.display = 'block';
        }else if(responseText.includes("captcha_failed")){
          alert("Captcha invalide. Merci de réessayer.");
        }else{
          // Success
          resultBlock.querySelectorAll('input,button,.g-recaptcha').forEach(el=>el.style.display='none');
          successMsg.textContent = "Merci ❤️ Votre analyse personnalisée a été envoyée à " + email + ".";
          successMsg.style.display = 'block';
        }
      })
      .catch(()=>{
        alert("Erreur réseau. Veuillez réessayer dans quelques instants.");
      });
    });

    // --- UX: Enter press selects next ---
    document.addEventListener('keydown', function(e){
      if(qCard.style.display!=='none' && (e.key==="Enter" || e.keyCode===13)){
        if(selected!==null){
          nextBtn.click();
          e.preventDefault();
        }
      }
    });

    // --- Prevent form submit on Enter in email field ---
    emailInput.addEventListener('keydown', function(e){
      if(e.key === "Enter") e.preventDefault();
    });

    // --- Reset duplicate message on input change ---
    emailInput.addEventListener('input',()=>{emailDupMsg.style.display='none';});

    // --- Smooth scroll to top on mobile at results ---
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- Hide result block on reload ---
    window.addEventListener('pageshow', function(){
      resultBlock.style.display = 'none';
      qCard.style.display = '';
      currentQ = 0;
      answers = [];
      showQuestion(0);
      progressBar.style.width = "0%";
    });
  </script>
</body>
</html>
