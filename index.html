
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test MetaLove - 105 questions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; margin: 2em; background: #fdf9f6; }
        .question { margin-bottom: 1.5em; }
        .answers label { display: block; margin: 0.3em 0; }
        .page { display: none; }
        .visible { display: block; }
        .progress { margin-top: 1em; }
        .hidden { display: none; }
        .navigation { margin-top: 2em; }
        button { padding: 0.5em 1em; }
    </style>
</head>
<body>
    <h1>üíñ Test MetaLove</h1>
    <form id="questionnaireForm">
        <div id="questionsContainer"></div>
        <div class="progress">
            <progress id="progressBar" value="0" max="21"></progress>
            <span id="progressText">Page 1/21</span>
        </div>
        <div class="navigation">
            <button type="button" id="nextPageBtn">Page suivante</button>
        </div>
        <div id="emailBlock" class="hidden">
            <h3>Derni√®re √©tape !</h3>
            <label for="email">Votre adresse e‚Äëmail pour recevoir les r√©sultats :</label>
            <input type="email" name="email" id="email" required />
            <div class="g-recaptcha" data-sitekey="SITE_KEY_PLACEHOLDER"></div>
            <button type="submit">Envoyer mes r√©sultats</button>
        </div>
    </form>
    <script>
        const csvUrl = 'questions.csv';
        const questionsPerPage = 5;
        let allQuestions = [];
        let page = 0;

        fetch(csvUrl)
            .then(response => response.text())
            .then(csv => {
                const rows = csv.split('\n').slice(1);
                allQuestions = rows.map(row => {
                    const cols = row.split(',');
                    return {
                        meta: cols[0],
                        text: cols[1]
                    };
                }).sort(() => Math.random() - 0.5); // M√©lange
                showPage(0);
            });

        function showPage(p) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            const start = p * questionsPerPage;
            const current = allQuestions.slice(start, start + questionsPerPage);

            current.forEach((q, i) => {
                const id = 'q_' + (start + i);
                const html = `
                    <div class="question">
                        <p><strong>${start + i + 1}.</strong> ${q.text}</p>
                        <div class="answers">
                            <label><input type="radio" name="${id}" value="100" required> Oui</label>
                            <label><input type="radio" name="${id}" value="50"> Souvent</label>
                            <label><input type="radio" name="${id}" value="25"> Rarement</label>
                            <label><input type="radio" name="${id}" value="0"> Non</label>
                        </div>
                    </div>`;
                container.innerHTML += html;
            });

            // Progression
            document.getElementById('progressBar').value = p + 1;
            document.getElementById('progressText').textContent = `Page ${p + 1}/21`;

            // Email bloc final
            document.getElementById('emailBlock').classList.toggle('hidden', p !== 20);
            document.getElementById('nextPageBtn').classList.toggle('hidden', p === 20);
        }

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            if (page < 20) {
                page++;
                showPage(page);
            }
        });

        document.getElementById('questionnaireForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const form = new FormData(this);
            const answers = {};
            for (let [key, value] of form.entries()) {
                if (key.startsWith('q_')) answers[key] = parseInt(value);
            }

            const scores = {};
            allQuestions.forEach((q, i) => {
                const val = answers['q_' + i];
                if (!scores[q.meta]) scores[q.meta] = [];
                if (!isNaN(val)) scores[q.meta].push(val);
            });

            const result = {};
            for (let meta in scores) {
                const arr = scores[meta];
                const sum = arr.reduce((a, b) => a + b, 0);
                result[meta] = Math.round(sum / arr.length);
            }

            const email = form.get('email');
            const payload = {
                email: email,
                scores: result
            };

            fetch("SUBMIT_URL_HERE", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("Merci ! Votre r√©sultat vous a √©t√© envoy√©.");
                window.location.reload();
            });
        });
    </script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</body>
</html>
